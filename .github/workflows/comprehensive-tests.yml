name: ðŸ§ª Grape Vector DB - ç»¼åˆæµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # å¿«é€Ÿå•å…ƒæµ‹è¯•
  unit-tests:
    name: ðŸ“‹ å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt
        
    - name: ðŸ“¦ ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ðŸ” ä»£ç æ ¼å¼æ£€æŸ¥
      run: cargo fmt --all -- --check
      
    - name: ðŸ“Ž Clippy æ£€æŸ¥
      run: cargo clippy --all-targets --all-features -- -D warnings
      
    - name: ðŸ—ï¸ æž„å»ºé¡¹ç›®
      run: cargo build --verbose
      
    - name: âœ… è¿è¡Œå•å…ƒæµ‹è¯•
      run: cargo test --lib --verbose

  # å†…åµŒæ¨¡å¼æµ‹è¯•
  embedded-mode-tests:
    name: ðŸ“¦ å†…åµŒæ¨¡å¼æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: unit-tests
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
        
    - name: ðŸ“¦ ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ðŸ§ª è¿è¡Œå†…åµŒæ¨¡å¼æµ‹è¯•
      run: cargo test --test embedded_mode_tests --verbose
      env:
        TEST_MODE: embedded
        
    - name: ðŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      if: always()
      run: |
        echo "## ðŸ“¦ å†…åµŒæ¨¡å¼æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "æµ‹è¯•å®Œæˆæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY

  # å•æœºæ¨¡å¼æµ‹è¯•
  standalone-mode-tests:
    name: ðŸ–¥ï¸ å•æœºæ¨¡å¼æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: unit-tests
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
        
    - name: ðŸ“¦ ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ðŸ§ª è¿è¡Œå•æœºæ¨¡å¼æµ‹è¯•
      run: cargo test --test standalone_mode_tests --verbose
      env:
        TEST_MODE: standalone

  # Raft å…±è¯†ç®—æ³•æµ‹è¯•
  raft-consensus-tests:
    name: ðŸ—³ï¸ Raft å…±è¯†ç®—æ³•æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: unit-tests
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
        
    - name: ðŸ“¦ ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ðŸ§ª è¿è¡Œ Raft ç®—æ³•æµ‹è¯•
      run: cargo test --test raft_comprehensive_tests --verbose
      env:
        RUST_LOG: info

  # åˆ†ç‰‡ç®—æ³•æµ‹è¯•  
  resharding-tests:
    name: ðŸ”€ Resharding åˆ†ç‰‡ç®—æ³•æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: unit-tests
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
        
    - name: ðŸ“¦ ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ðŸ§ª è¿è¡Œåˆ†ç‰‡ç®—æ³•æµ‹è¯•
      run: cargo test --test resharding_comprehensive_tests --verbose
      env:
        RUST_LOG: info

  # é›†ç¾¤æ¨¡å¼æµ‹è¯•
  cluster-mode-tests:
    name: ðŸ­ é›†ç¾¤æ¨¡å¼æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 90
    needs: [raft-consensus-tests, resharding-tests]
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
        
    - name: ðŸ“¦ ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ðŸ§ª è¿è¡Œé›†ç¾¤æ¨¡å¼æµ‹è¯•
      run: cargo test --test cluster_mode_tests --verbose
      env:
        RUST_LOG: info

  # æµ‹è¯•æ€»ç»“
  test-summary:
    name: ðŸ“‹ æµ‹è¯•æ€»ç»“
    runs-on: ubuntu-latest
    needs: [embedded-mode-tests, standalone-mode-tests, raft-consensus-tests, resharding-tests, cluster-mode-tests]
    if: always()
    
    steps:
    - name: ðŸ“Š ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
      run: |
        echo "# ðŸ§ª Grape Vector DB ç»¼åˆæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ˆ æµ‹è¯•è¦†ç›–æƒ…å†µ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å†…åµŒæ¨¡å¼æµ‹è¯•: ${{ needs.embedded-mode-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å•æœºæ¨¡å¼æµ‹è¯•: ${{ needs.standalone-mode-tests.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… Raftå…±è¯†ç®—æ³•æµ‹è¯•: ${{ needs.raft-consensus-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åˆ†ç‰‡ç®—æ³•æµ‹è¯•: ${{ needs.resharding-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… é›†ç¾¤æ¨¡å¼æµ‹è¯•: ${{ needs.cluster-mode-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ æµ‹è¯•ç›®æ ‡è¾¾æˆ" >> $GITHUB_STEP_SUMMARY
        echo "- [x] å†…åµŒæ¨¡å¼åŠŸèƒ½éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- [x] å•æœºæ¨¡å¼æœåŠ¡éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- [x] 3èŠ‚ç‚¹é›†ç¾¤å…±è¯†éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- [x] 6èŠ‚ç‚¹é›†ç¾¤æ‰©å±•æ€§éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Raftç®—æ³•æ­£ç¡®æ€§éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "- [x] åˆ†ç‰‡ç®—æ³•æ•ˆçŽ‡éªŒè¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æµ‹è¯•å®Œæˆæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY